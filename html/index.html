<!DOCTYPE html>
<html lang="en-us">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, user-scalable=no, maximum-scale=1">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="mobile-web-app-capable" content="yes">
<title>ButonTap</title>

<style>
:root {
  --sat: env(safe-area-inset-top);
  --sab: env(safe-area-inset-bottom);
  --sal: env(safe-area-inset-left);
  --sar: env(safe-area-inset-right);
}

* {
  -webkit-tap-highlight-color: transparent;
  -webkit-touch-callout: none;
  -webkit-user-select: none;
  user-select: none;
}

html, body {
  margin: 0;
  padding: 0;
  width: 100%;
  height: 100%;
  position: relative;
  background: #000;
  overflow: hidden;
  overscroll-behavior: none;
  touch-action: none;
}

body {
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
}

#splash1 {
  position: fixed;
  inset: 0;
  background: #000;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  z-index: 10000;
  transition: opacity .5s;
}
#splash1.hidden {
  opacity: 0;
  pointer-events: none;
}
#splash1 img {
  width: 150px;
  height: 150px;
  object-fit: contain;
  margin-bottom: 20px;
}

#splash2 {
  position: fixed;
  inset: 0;
  background: #0b0b0f;
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 9999;
}
#splash2.show {
  display: flex;
}

.loader-wrap {
  position: relative;
  display: flex;
  align-items: center;
  justify-content: center;
}

.glow {
  position: absolute;
  width: 180px;
  height: 180px;
  border-radius: 50%;
  background: radial-gradient(
    circle,
    rgba(255,255,255,0.12) 0%,
    rgba(255,255,255,0.06) 30%,
    rgba(255,255,255,0.0) 65%
  );
  filter: blur(18px);
  animation: glowPulse 2.4s ease-in-out infinite;
}

.loader {
  position: relative;
  width: 90px;
  height: 90px;
  animation: breathe 1.6s ease-in-out infinite;
}

.ring.outer {
  position: absolute;
  inset: 0;
  border-radius: 50%;
  border: 4px solid rgba(255,255,255,0.12);
  border-top-color: rgba(255,255,255,0.95);
  animation: spin 1.1s linear infinite;
}

.ring.inner {
  position: absolute;
  inset: 14px;
  border-radius: 50%;
  border: 3px solid rgba(255,255,255,0.10);
  border-bottom-color: rgba(255,255,255,0.7);
  animation: spinReverse 0.9s linear infinite;
}

@keyframes spin {
  to { transform: rotate(360deg); }
}

@keyframes spinReverse {
  to { transform: rotate(-360deg); }
}

@keyframes breathe {
  0%, 100% { transform: scale(1); }
  50% { transform: scale(1.08); }
}

@keyframes glowPulse {
  0%, 100% { opacity: 0.7; }
  50% { opacity: 1; }
}

#unity-container {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  width: 100vw;
  height: 100vh;
  opacity: 0;
  transition: opacity .5s;
  isolation: isolate;
  z-index: 1;
}
#unity-container.ready {
  opacity: 1;
}

#unity-canvas {
  background: #231F20;
  display: block;
  touch-action: none;
  pointer-events: auto;
}

@media (min-width: 768px) {
  body {
    text-align: center;
  }
  #unity-canvas {
    width: 1080px !important;
    height: 1920px !important;
    position: relative !important;
    margin: 0 auto;
  }
}

@media (max-width: 767px) {
  #unity-canvas {
    width: 100% !important;
    height: 100% !important;
    position: fixed !important;
    top: 0 !important;
    left: 0 !important;
  }
}

#error-screen {
  position: fixed;
  inset: 0;
  background: #000;
  color: #fff;
  display: none;
  align-items: center;
  justify-content: center;
  padding: 20px;
  text-align: center;
  font-family: system-ui;
  z-index: 100000;
}
#error-screen.show {
  display: flex;
}
</style>
</head>

<body>

<div id="error-screen"></div>

<div id="splash1">
  <img src="logo.png" alt="ButonTap">
</div>

<div id="splash2">
  <div class="loader-wrap">
    <div class="glow"></div>
    <div class="loader">
      <div class="ring outer"></div>
      <div class="ring inner"></div>
    </div>
  </div>
</div>

<div id="unity-container">
  <canvas id="unity-canvas"></canvas>
</div>

<script>
// ===== TELEGRAM THEME INTEGRATION =====
(function() {
  try {
    const tg = window.Telegram?.WebApp;
    if (tg) {
      const bg = tg.themeParams?.bg_color;
      if (bg) {
        document.documentElement.style.background = bg.startsWith('#') ? bg : '#' + bg;
      }
    }
  } catch (e) {
    console.warn('Telegram theme not available');
  }
})();

// Загрузка Telegram SDK
const tgScript = document.createElement('script');
tgScript.src = 'https://telegram.org/js/telegram-web-app.js';
tgScript.onerror = function() {
  showError(
    '❌ Ошибка загрузки',
    'Не удалось подключиться к Telegram',
    'Откройте приложение через Telegram и попробуйте снова'
  );
};
tgScript.onload = function() {
  checkTelegramSDK();
};
document.head.appendChild(tgScript);

function showError(title, message, instructions) {
  const errorScreen = document.getElementById("error-screen");
  errorScreen.innerHTML = `
    <div>
      <h2 style="color:#f00;margin-bottom:20px;font-size:24px">${title}</h2>
      <p style="margin-bottom:15px;font-size:16px">${message}</p>
      <p style="font-size:14px;color:#aaa;white-space:pre-line;margin-bottom:20px">${instructions}</p>
      <button onclick="location.reload()" style="padding:12px 24px;font-size:16px;background:#ff0;border:none;border-radius:8px;cursor:pointer;color:#000;font-weight:bold;touch-action:manipulation">
        Перезагрузить
      </button>
    </div>
  `;
  errorScreen.classList.add("show");
}

function checkTelegramSDK() {
  const maxWait = 3000;
  const startTime = Date.now();
  
  function check() {
    if (window.Telegram && window.Telegram.WebApp) {
      loadUnityLoader();
      return;
    }
    
    if (Date.now() - startTime > maxWait) {
      showError(
        "⚠️ Ошибка запуска",
        "Приложение должно открываться внутри Telegram",
        "Откройте приложение через бота"
      );
      return;
    }
    
    setTimeout(check, 100);
  }
  
  check();
}

function loadUnityLoader() {
  const unityScript = document.createElement('script');
  const timestamp = Date.now();
  unityScript.src = `Build/butontapgame39.loader.js?v=${timestamp}`;
  
  unityScript.onerror = function() {
    showError(
      "❌ Ошибка загрузки",
      "Не удалось загрузить игру",
      "Проверьте подключение к интернету"
    );
  };
  
  unityScript.onload = function() {
    if (typeof createUnityInstance !== 'function') {
      showError(
        "❌ Ошибка",
        "Игра повреждена",
        "Попробуйте позже"
      );
      return;
    }
    
    setTimeout(initApp, 300);
  };
  
  document.head.appendChild(unityScript);
}

function initApp() {
  let unityInstance = null;
  let unityLoading = false;

  const tg = window.Telegram.WebApp;
  let platform = tg.platform || "unknown";
  let isIOS = platform === "ios";
  let isAndroid = platform === "android";

  if (platform === "unknown") {
    const ua = navigator.userAgent;
    if (/iPad|iPhone|iPod/.test(ua)) {
      platform = "ios";
      isIOS = true;
    } else if (/Android/.test(ua)) {
      platform = "android";
      isAndroid = true;
    }
  }

  // ===== TELEGRAM INIT =====
  function initTelegram() {
    try {
      tg.ready();
      tg.expand();
      
      if (isIOS) {
        if (typeof tg.setHeaderColor === 'function') tg.setHeaderColor('#000000');
        if (typeof tg.enableClosingConfirmation === 'function') tg.enableClosingConfirmation();
      }

      const user = tg.initDataUnsafe?.user;

      if (!user?.id) {
        return;
      }

      const payload = JSON.stringify({
        id: user.id,
        username: user.username || "Player",
        first_name: user.first_name || "Player"
      });

      if (!unityInstance) {
        setTimeout(initTelegram, 300);
        return;
      }

      try {
        unityInstance.SendMessage("TelegramBridge", "SetTelegramData", payload);
      } catch (e) {
        console.error("Failed to send Telegram data:", e);
      }
    } catch (e) {
      console.error("Telegram init error:", e);
    }
  }

  // ===== UNITY CONFIG =====
  const config = {
    dataUrl: "Build/butontapgame39.data.unityweb?v=39",
    frameworkUrl: "Build/butontapgame39.framework.js.unityweb?v=39",
    codeUrl: "Build/butontapgame39.wasm.unityweb?v=39",
    streamingAssetsUrl: "StreamingAssets",
    companyName: "Hakaki",
    productName: "ButonTap",
    productVersion: "1.0"
  };

  let loadAttempt = 0;
  const maxAttempts = 2;

  // ===== UNITY LOADER =====
  function startUnity() {
    if (unityInstance || unityLoading) {
      return;
    }

    unityLoading = true;
    loadAttempt++;
    
    const splash1 = document.getElementById("splash1");
    const splash2 = document.getElementById("splash2");
    const canvas = document.getElementById("unity-canvas");
    
    setTimeout(() => {
      splash1.classList.add("hidden");
      splash2.classList.add("show");
    }, 1500);
    
    const unityStartDelay = isIOS ? 300 : 0;
    
    setTimeout(() => {
      createUnityInstance(canvas, config, (progress) => {
        // Прогресс загрузки (опционально можно вывести)
      }).then(instance => {
        unityInstance = instance;
        window.unityInstance = instance;
        unityLoading = false;
        
        splash2.classList.remove("show");
        document.getElementById("unity-container").classList.add("ready");
        
        setTimeout(() => {
          initTelegram();
        }, isIOS ? 300 : 0);
        
      }).catch(err => {
        unityLoading = false;
        console.error("Unity load error:", err);
        
        if (loadAttempt < maxAttempts) {
          setTimeout(() => {
            splash2.classList.remove("show");
            splash1.classList.remove("hidden");
            unityInstance = null;
            startUnity();
          }, 2000);
          return;
        }
        
        showError(
          "❌ Ошибка загрузки",
          "Не удалось запустить игру",
          "Попробуйте:\n1. Перезапустить Telegram\n2. Проверить интернет"
        );
      });
    }, unityStartDelay);
  }

  // ===== PAYMENT =====
  window.OpenPayment = function(url) {
    if (!url) return;

    try {
      if (isIOS) {
        if (url.includes("t.me/CryptoBot/app?startapp=invoice")) {
          const match = url.match(/invoice-([^&]+)/);
          if (match && match[1]) {
            url = `https://t.me/CryptoBot?start=${match[1]}`;
          }
        }
        tg.openLink(url);
        return;
      }

      if (isAndroid) {
        const isWebAppInvoice = url.startsWith("https://app.cr.bot/invoices/");
        const canOpenInvoice = typeof tg.openInvoice === 'function';
        
        if (isWebAppInvoice && canOpenInvoice) {
          tg.openInvoice(url, function(status) {
            if (status === "paid" && unityInstance) {
              try {
                unityInstance.SendMessage("GameManager", "OnPaymentSuccess");
              } catch (e) {
                console.error("Payment notification failed:", e);
              }
            }
          });
          return;
        }
        
        tg.openLink(url);
        return;
      }

      tg.openLink(url);
      
    } catch (error) {
      console.error("Payment error:", error);
      try {
        window.open(url, "_blank");
      } catch (e) {
        console.error("Fallback failed:", e);
      }
    }
  };

  window.OpenPaymentUrl = window.OpenPayment;
  window.openPaymentUrl = window.OpenPayment;
  window.OpenTelegramLink = window.OpenPayment;
  window.OpenTelegramInvoice = window.OpenPayment;

  // ===== iOS HANDLERS =====
  if (isIOS) {
    document.addEventListener('touchmove', function(e) {
      if (e.target.closest('#unity-canvas')) {
        return;
      }
      e.preventDefault();
    }, { passive: false });
  }

  document.addEventListener('contextmenu', function(e) {
    if (e.target.closest('#unity-canvas')) {
      e.preventDefault();
    }
  }, false);

  let lastTouchEnd = 0;
  document.addEventListener('touchend', function(e) {
    if (e.target.closest('#unity-canvas')) return;
    
    const now = Date.now();
    if (now - lastTouchEnd <= 300) {
      e.preventDefault();
    }
    lastTouchEnd = now;
  }, false);

  startUnity();
}
</script>

</body>
</html>
